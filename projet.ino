/*
 * ESP32 WiFi Sniffing -> LoRaWAN (EU868)
 * ÂäüËÉΩÔºöÊâ´Êèè WiFiÔºå„Äê‰ªÖ‰øùÁïôÊï∞ÊçÆÂ∫ìÁôΩÂêçÂçïÂÜÖÁöÑ MAC„ÄëÔºåÈÄâÂèñ‰ø°Âè∑ÊúÄÂº∫ÁöÑ 3 ‰∏™ÂèëÈÄÅ
 * Ëß£ÂÜ≥ÈóÆÈ¢òÔºöÂâîÈô§Âπ≤Êâ∞ÁÉ≠ÁÇπÔºåÁ°Æ‰øù‰∏ä‰º†ÁöÑ MAC ÈÉΩËÉΩÂú® Node-RED Êï∞ÊçÆÂ∫ì‰∏≠ÊâæÂà∞Âπ∂ÂÆö‰Ωç
 */

#include <WiFi.h>

HardwareSerial LoRa(2);

// ======== USER CONFIG (Áî®Êà∑ÈÖçÁΩÆ) ========
// Âá≠ËØÅÊù•Ê∫ê
const char* APP_EUI = "0000000000000000";       
const char* DEV_EUI = "70B3D57ED0073224";      
const char* APP_KEY = "CF37EEE136B9EC086ABEB19E4C14FD8C"; 

// EU868 ËÆæÁΩÆ
const int JOIN_DR   = 5;            
const int UPLINK_DR = 5;            
const int LORAWAN_PORT = 10;

const int N = 3; // ÂÆûÈ™åË¶ÅÊ±Ç‰∏ä‰º† 3 ‰∏™Âü∫Á´ô 
const uint32_t PERIOD_MS = 60000;
// =======================================

// üî• ÁôΩÂêçÂçïËÆæÁΩÆÔºöÂ∑≤Ê†πÊçÆ‰Ω†ÊúÄÊñ∞Á≠õÈÄâÂá∫ÁöÑÂõ∫ÂÆö WiFi ÁôΩÂêçÂçïÊõ¥Êñ∞
// Âè™ÊúâÊâ´ÊèèÂà∞Ëøô‰∫õ MACÔºåÊâç‰ºöË¢´Áî®Êù•ÂÆö‰Ωç
const int WHITELIST_SIZE = 967;
const char* WHITELIST[WHITELIST_SIZE] = {
  "00:05:B5:44:66:FE", "00:0F:00:4F:84:59", "00:1B:93:01:13:9C", "00:1B:93:01:13:C7",
  "00:1B:93:E2:00:01", "00:23:12:1D:0B:61", "00:25:42:82:70:F2", "00:37:B7:66:02:74",
  "00:B1:E3:25:31:F0", "00:F2:8B:03:73:5B", "00:F2:8B:03:73:5D", "00:F2:8B:03:73:5E",
  "00:F2:8B:06:8B:52", "00:F2:8B:06:8B:54", "00:F2:8B:06:8B:5B", "00:F2:8B:06:8D:9B",
  "00:F2:8B:06:8D:9E", "00:F2:8B:06:96:94", "00:F2:8B:06:96:9B", "00:F2:8B:06:96:9D",
  "00:F2:8B:06:96:9E", "00:F2:8B:06:B6:21", "00:F2:8B:06:B6:22", "00:F2:8B:06:B6:24",
  "00:F2:8B:06:B6:2B", "00:F2:8B:06:B6:2D", "00:F2:8B:06:B6:2E", "00:F2:8B:08:34:92",
  "00:F2:8B:08:34:94", "00:F2:8B:08:34:9B", "00:F2:8B:08:34:9D", "00:F2:8B:08:34:9E",
  "00:F2:8B:55:54:24", "00:F2:8B:55:54:2B", "00:F2:8B:55:54:2D", "00:F2:8B:55:54:2E",
  "00:F2:8B:55:54:F4", "00:F2:8B:55:54:FB", "00:F2:8B:55:54:FD", "00:F2:8B:55:54:FE",
  "00:F6:63:AC:D6:31", "00:F6:63:AC:D6:32", "00:F6:63:AC:D6:34", "00:F6:63:AC:D6:3B",
  "00:F6:63:AC:D6:3D", "00:F6:63:AC:D6:3E", "00:F6:63:AC:D8:31", "00:F6:63:AC:D8:32",
  "00:F6:63:AC:D8:34", "00:F6:63:AC:D8:3B", "00:F6:63:AC:D8:3D", "00:F6:63:AC:D8:3E",
  "00:F6:63:B1:CD:91", "00:F6:63:B1:CD:92", "00:F6:63:B1:CD:94", "00:F6:63:B1:CD:9B",
  "00:F6:63:B1:CD:9D", "00:F6:63:B1:CD:9E", "00:F6:63:B1:CE:81", "00:F6:63:B1:CE:8B",
  "00:F6:63:B1:CE:8D", "00:F6:63:B1:CE:8E", "00:F6:63:B1:CF:01", "00:F6:63:B1:CF:02",
  "00:F6:63:B1:CF:04", "00:F6:63:B1:CF:0B", "00:F6:63:B1:CF:0D", "00:F6:63:B1:CF:0E",
  "00:F6:63:B1:D0:3B", "00:F6:63:B1:D0:3D", "00:F6:63:C7:28:CB", "00:F6:63:C7:28:CD",
  "00:F6:63:C7:28:CE", "00:F6:63:C7:29:5B", "00:F6:63:C7:29:5D", "00:F6:63:C7:29:5E",
  "00:F6:63:C7:29:9D", "00:F6:63:C7:29:9E", "00:F6:63:C7:29:A1", "00:F6:63:C7:29:A2",
  "00:F6:63:C7:29:A4", "00:F6:63:C7:29:AB", "00:F6:63:C7:29:AD", "00:F6:63:C7:29:AE",
  "00:F6:63:C7:2A:71", "00:F6:63:C7:2A:72", "00:F6:63:C7:2A:74", "00:F6:63:C7:2A:7B",
  "00:F6:63:C7:2A:7D", "00:F6:63:C7:2A:7E", "00:F6:63:C7:2A:F1", "00:F6:63:C7:2A:F2",
  "00:F6:63:C7:2A:F4", "00:F6:63:C7:2A:FB", "00:F6:63:C7:2A:FD", "00:F6:63:C7:2A:FE",
  "00:F6:63:C7:2D:C1", "00:F6:63:C7:2D:C2", "00:F6:63:C7:2D:C4", "00:F6:63:C7:2D:CB",
  "00:F6:63:C7:2D:CD", "00:F6:63:C7:2D:CE", "00:F6:63:CA:DD:A1", "00:F6:63:CA:DD:A2",
  "00:F6:63:CA:DD:A4", "00:F6:63:CA:DD:AB", "00:F6:63:CA:DD:AD", "00:F6:63:CA:DD:AE",
  "00:F6:63:CE:C6:51", "00:F6:63:CE:C6:52", "00:F6:63:CE:C6:54", "00:F6:63:CE:C6:5B",
  "00:F6:63:CE:C6:5D", "00:F6:63:CE:C6:5E", "00:F6:63:CE:C9:5E", "00:F6:63:CE:D3:0D",
  "00:F6:63:CE:D3:0E", "00:F6:63:DD:36:C1", "00:F6:63:DD:36:C2", "00:F6:63:DD:36:C4",
  "00:F6:63:DD:36:CB", "00:F6:63:DD:36:CD", "00:F6:63:DD:36:CE", "00:F6:63:DD:3C:F1",
  "00:F6:63:DD:3C:F2", "00:F6:63:DD:3C:F4", "00:F6:63:DD:3C:FB", "00:F6:63:DD:3C:FD",
  "00:F6:63:DD:3C:FE", "00:F6:63:DD:3D:C1", "00:F6:63:DD:3D:C2", "00:F6:63:DD:3D:C4",
  "00:F6:63:DD:3D:CB", "00:F6:63:DD:3D:CD", "00:F6:63:DD:3D:CE", "00:F6:63:DD:3D:F1",
  "00:F6:63:DD:3D:F2", "00:F6:63:DD:3D:F4", "00:F6:63:DD:3D:FB", "00:F6:63:DD:3D:FE",
  "00:F6:63:DD:4B:6B", "00:F6:63:DD:4B:6D", "00:F6:63:DD:4B:6E", "00:F6:63:DD:4B:C1",
  "00:F6:63:DD:4B:C4", "00:F6:63:DD:4B:CB", "00:F6:63:DD:4B:CD", "00:F6:63:DD:4B:CE",
  "00:F6:63:E6:2E:B1", "00:F6:63:E6:2E:B2", "00:F6:63:E6:2E:B4", "00:F6:63:E6:2E:BB",
  "00:F6:63:E6:2E:BD", "00:F6:63:E6:2E:BE", "00:F6:63:E6:2E:D1", "00:F6:63:E6:2E:D2",
  "00:F6:63:E6:2E:D4", "00:F6:63:E6:2E:DB", "00:F6:63:E6:2E:DD", "00:F6:63:E6:2E:DE",
  "00:F6:63:E6:2E:F1", "00:F6:63:E6:2E:F2", "00:F6:63:E6:2E:F4", "00:F6:63:E6:2E:FB",
  "00:F6:63:E6:2E:FD", "00:F6:63:E6:2E:FE", "00:F6:63:E6:2F:C1", "00:F6:63:E6:2F:C2",
  "00:F6:63:E6:2F:CB", "00:F6:63:E6:2F:CD", "00:F6:63:E6:2F:CE", "00:F6:63:E6:3A:2B",
  "00:F6:63:E6:3A:2D", "00:F6:63:E6:3A:AB", "00:F6:63:E6:3A:AD", "00:F6:63:E6:3A:AE",
  "00:F6:63:E6:3B:82", "00:F6:63:E6:3B:8E", "00:FE:C8:DD:17:41", "00:FE:C8:DD:17:42",
  "00:FE:C8:DD:17:44", "00:FE:C8:DD:17:4B", "00:FE:C8:DD:17:4D", "00:FE:C8:DD:17:4E",
  "00:FE:C8:DD:36:81", "00:FE:C8:DD:36:82", "00:FE:C8:DD:36:84", "00:FE:C8:DD:36:8B",
  "00:FE:C8:DD:36:8E", "00:FE:C8:DD:36:A1", "00:FE:C8:DD:36:A2", "00:FE:C8:DD:36:A4",
  "00:FE:C8:DD:36:AB", "00:FE:C8:DD:36:AD", "00:FE:C8:DD:36:AE", "00:FE:C8:DD:42:41",
  "00:FE:C8:DD:42:42", "00:FE:C8:DD:42:4B", "00:FE:C8:DD:42:4D", "00:FE:C8:DD:42:4E",
  "00:FE:C8:EF:9A:C1", "00:FE:C8:EF:9A:CB", "00:FE:C8:EF:9A:CD", "00:FE:C8:EF:9A:CE",
  "00:FE:C8:EF:9C:11", "00:FE:C8:EF:9C:12", "00:FE:C8:EF:9C:14", "00:FE:C8:EF:9C:1B",
  "00:FE:C8:EF:9C:1D", "00:FE:C8:F1:25:CB", "00:FE:C8:F1:3B:61", "00:FE:C8:F1:3B:6B",
  "00:FE:C8:F1:3B:6D", "00:FE:C8:F1:3B:6E", "00:FE:C8:F1:3D:91", "00:FE:C8:F1:3D:94",
  "00:FE:C8:F1:3D:9E", "00:FE:C8:FD:A9:B1", "00:FE:C8:FD:A9:B2", "00:FE:C8:FD:A9:BB",
  "00:FE:C8:FD:A9:BE", "00:FE:C8:FD:B2:0B", "00:FE:C8:FD:B2:0D", "00:FE:C8:FD:B2:0E",
  "00:FE:C8:FD:B2:51", "00:FE:C8:FD:B2:54", "00:FE:C8:FD:B2:5B", "00:FE:C8:FD:B2:5D",
  "00:FE:C8:FD:B2:5E", "00:FE:C8:FD:B3:0B", "00:FE:C8:FD:B3:0D", "00:FE:C8:FD:B3:0E",
  "04:70:56:BF:97:5C", "04:70:56:BF:97:61", "04:92:26:7C:1E:69", "04:D4:C4:0A:AC:F0",
  "04:D4:C4:0A:AC:F4", "04:D9:F5:74:E0:B0", "04:D9:F5:74:E0:B4", "04:E3:1A:9F:18:40",
  "04:E3:1A:9F:18:45", "08:3A:F2:AB:BE:FD", "08:3A:F2:BA:61:DD", "08:3A:F2:BA:7F:A1",
  "08:45:D1:3B:83:00", "08:45:D1:3B:83:01", "08:45:D1:3B:83:03", "08:45:D1:3B:83:04",
  "08:5A:11:28:8A:10", "08:5A:11:28:8A:11", "08:5A:11:28:8A:14", "08:5A:11:28:8A:21",
  "08:5A:11:28:8A:28", "08:5A:11:28:8A:29", "08:5A:11:28:8A:2C", "10:27:F5:CD:AD:FB",
  "10:27:F5:CD:AD:FC", "10:B3:D5:B6:E8:42", "10:B3:D5:B6:E8:43", "10:B3:D5:B6:E8:4C",
  "10:B3:D5:B6:E8:4D", "10:B3:D5:C2:AF:C2", "10:B3:D5:C2:AF:C3", "10:B3:D5:C2:AF:CC",
  "10:B3:D5:C2:AF:CD", "10:B3:D5:C2:B0:82", "10:B3:D5:C2:B0:83", "10:B3:D5:C2:B0:8C",
  "10:B3:D5:C2:B0:8D", "10:B3:D5:DC:ED:22", "10:B3:D5:DC:ED:23", "10:B3:D5:DC:ED:2C",
  "10:B3:D5:DC:ED:2D", "10:E9:92:4F:13:15", "14:0C:76:55:9D:D5", "14:0C:76:7E:53:12",
  "14:0C:76:7E:53:13", "18:33:9D:70:5A:00", "18:33:9D:70:5A:01", "18:33:9D:70:5A:03",
  "18:33:9D:70:5A:04", "18:33:9D:70:5A:0B", "18:33:9D:70:5A:0C", "18:33:9D:70:5A:0D",
  "18:33:9D:70:5A:0E", "18:33:9D:70:5A:0F", "18:33:9D:70:5A:30", "18:33:9D:70:5A:31",
  "18:33:9D:70:5A:32", "18:33:9D:70:5A:33", "18:33:9D:70:5A:34", "18:33:9D:70:8B:50",
  "18:33:9D:70:8B:51", "18:33:9D:70:8B:52", "18:33:9D:70:8B:53", "18:33:9D:70:8B:54",
  "18:33:9D:70:97:10", "18:33:9D:70:97:11", "18:33:9D:70:97:12", "18:33:9D:70:97:13",
  "18:33:9D:70:97:14", "18:33:9D:70:97:1B", "18:33:9D:70:97:1C", "18:33:9D:70:97:1D",
  "18:33:9D:70:97:1E", "18:33:9D:70:97:1F", "18:33:9D:70:9B:90", "18:33:9D:70:9B:91",
  "18:33:9D:70:9B:92", "18:33:9D:70:9B:93", "18:33:9D:70:9B:94", "18:33:9D:70:9B:9B",
  "18:33:9D:70:9B:9C", "18:33:9D:70:9B:9D", "18:33:9D:70:9B:9E", "18:33:9D:70:9B:9F",
  "18:64:72:05:D9:20", "18:64:72:05:D9:22", "18:64:72:05:D9:32", "18:82:8C:7D:56:C4",
  "18:8B:9D:91:F8:71", "18:8B:9D:91:F8:7C", "18:8B:9D:91:F8:7D", "18:8B:9D:91:F8:7E",
  "18:8B:9D:91:F8:7F", "18:8B:9D:92:23:71", "18:8B:9D:92:23:72", "18:8B:9D:92:23:74",
  "18:8B:9D:92:23:7B", "18:8B:9D:92:23:7D", "18:8B:9D:92:23:7E", "1C:57:3E:D0:86:F0",
  "1C:B9:C4:2E:38:0A", "1C:B9:C4:2E:38:0E", "1C:B9:C4:6E:38:0A", "1C:B9:C4:6E:38:0E",
  "20:66:CF:E7:F8:38", "20:97:27:0D:37:F7", "20:AA:4B:63:EB:EC", "24:7F:20:C6:25:AF",
  "24:94:94:F6:9F:75", "24:95:04:CD:3A:64", "24:DE:C6:29:7A:30", "24:DE:C6:29:7A:31",
  "24:DE:C6:29:7A:32", "30:5A:3A:93:45:5F", "30:7C:B2:A7:B0:1B", "34:27:92:4F:63:A7",
  "34:27:92:51:A8:EC", "34:27:92:C2:75:48", "34:27:92:C2:75:49", "34:27:92:C8:22:D0",
  "34:27:92:E8:9F:9C", "34:27:92:E8:9F:9D", "34:27:92:F7:0E:58", "38:A6:59:09:E8:A4",
  "38:A6:59:1D:CC:A0", "38:A6:59:1D:CC:A5", "38:A6:59:2B:56:F5", "38:B5:C9:10:28:55",
  "38:FF:36:44:0C:D8", "38:FF:36:44:0C:DC", "38:FF:36:C4:0C:D9", "38:FF:36:C4:0C:DD",
  "3C:98:72:E0:31:39", "40:3F:8C:A2:07:60", "40:3F:8C:A2:07:61", "40:5F:7D:3B:D6:7E",
  "40:A5:EF:D2:F2:BE", "40:CE:24:DA:7B:51", "40:CE:24:DA:7B:52", "40:CE:24:DA:7B:54",
  "40:CE:24:DA:7B:5B", "40:CE:24:DA:7B:5D", "40:CE:24:DA:7B:5E", "44:CE:7D:D5:5B:B6",
  "44:D4:54:58:7A:30", "44:D4:54:B3:A7:B0", "44:D4:54:EF:4D:20", "4C:60:DE:3C:2C:FB",
  "4C:60:DE:3C:2C:FC", "4C:71:0D:0D:95:E2", "4C:71:0D:0D:95:E3", "4C:71:0D:0D:95:EC",
  "4C:71:0D:0D:95:ED", "4C:71:0D:0E:DA:22", "4C:71:0D:0E:DA:23", "4C:71:0D:0E:DA:2C",
  "4C:71:0D:0E:DA:2D", "4C:71:0D:0F:A5:A2", "4C:71:0D:0F:A5:A3", "50:0F:F5:3D:A3:49",
  "50:0F:F5:3D:A3:51", "50:39:2F:F7:10:D0", "50:D4:F7:48:DF:F3", "54:13:10:AD:36:24",
  "54:13:10:AD:36:2C", "54:B8:0A:31:74:40", "54:B8:0A:31:74:48", "58:1D:D8:1B:B0:C4",
  "58:97:BD:07:D6:61", "58:97:BD:07:D6:62", "58:97:BD:07:D6:64", "58:97:BD:07:D6:6B",
  "58:97:BD:07:D6:6D", "58:97:BD:07:D6:6E", "58:97:BD:44:88:61", "58:97:BD:44:88:62",
  "58:97:BD:44:88:64", "58:97:BD:44:88:6B", "58:97:BD:44:88:6D", "58:97:BD:44:88:6E",
  "58:97:BD:5D:63:1B", "58:97:BD:5D:63:1D", "58:97:BD:5D:63:1E", "58:97:BD:80:CC:B0",
  "58:97:BD:80:CC:B1", "58:97:BD:80:CC:B2", "58:97:BD:80:CC:B3", "58:97:BD:80:CC:BC",
  "58:97:BD:80:CC:BD", "58:97:BD:80:CC:BE", "58:97:BD:80:CC:BF", "58:97:BD:83:B8:01",
  "58:97:BD:83:B8:02", "58:97:BD:83:B8:04", "58:97:BD:83:B8:0B", "58:97:BD:83:B8:0D",
  "58:97:BD:83:B8:0E", "58:97:BD:9C:AC:0E", "58:97:BD:9C:B0:82", "58:97:BD:9C:B0:84",
  "58:97:BD:9C:B0:8B", "58:97:BD:9C:B0:8D", "58:97:BD:9C:B0:8E", "58:97:BD:9C:B0:EB",
  "58:97:BD:9C:B0:ED", "58:97:BD:9C:B0:EE", "58:97:BD:9C:B2:00", "58:97:BD:9C:B2:01",
  "58:97:BD:9C:B2:02", "58:97:BD:9C:B2:03", "58:97:BD:A5:E0:B0", "58:97:BD:A5:E0:B1",
  "58:97:BD:A5:E0:B2", "58:97:BD:A5:E0:B3", "58:97:BD:A5:E0:B4", "58:97:BD:A5:E0:BB",
  "58:97:BD:A5:E0:BC", "58:97:BD:A5:E0:BD", "58:97:BD:A5:E0:BE", "58:97:BD:A5:E0:BF",
  "58:97:BD:A5:E1:24", "58:97:BD:A5:E1:2B", "58:97:BD:A5:E1:2D", "58:97:BD:A5:E1:2E",
  "58:97:BD:A5:E1:7E", "58:97:BD:BB:FE:C0", "58:97:BD:BB:FE:C1", "58:97:BD:BB:FE:C2",
  "58:97:BD:BB:FE:C3", "58:97:BD:BB:FE:CC", "58:97:BD:BB:FE:CD", "58:97:BD:BB:FE:CE",
  "58:97:BD:BB:FE:CF", "58:97:BD:BC:10:B1", "58:97:BD:BC:10:B2", "58:97:BD:BC:10:B4",
  "58:97:BD:BC:10:BB", "58:97:BD:BC:10:BD", "58:97:BD:BC:10:BE", "58:97:BD:CD:8C:C1",
  "58:97:BD:CD:8C:C4", "58:97:BD:CD:8C:CB", "58:97:BD:CD:8C:CD", "58:97:BD:CD:8C:CE",
  "58:97:BD:CD:91:81", "58:97:BD:CD:91:82", "58:97:BD:CD:91:84", "58:97:BD:CD:91:8B",
  "58:97:BD:CD:91:8D", "58:97:BD:CD:91:8E", "58:97:BD:CD:91:9D", "58:97:BD:CD:91:9E",
  "58:97:BD:CD:92:60", "58:97:BD:CD:92:61", "58:97:BD:CD:92:62", "58:97:BD:CD:92:63",
  "58:97:BD:CD:92:6C", "58:97:BD:CD:92:6D", "58:97:BD:CD:92:6E", "58:97:BD:CD:92:6F",
  "58:97:BD:CD:93:E0", "58:97:BD:CD:93:E1", "58:97:BD:CD:93:E2", "58:97:BD:CD:93:E3",
  "58:97:BD:CD:93:EC", "58:97:BD:CD:93:ED", "58:97:BD:CD:93:EE", "58:97:BD:CD:93:EF",
  "58:97:BD:CD:94:80", "58:97:BD:CD:94:81", "58:97:BD:CD:94:82", "58:97:BD:CD:94:83",
  "58:97:BD:CD:94:8C", "58:97:BD:CD:94:8D", "58:97:BD:CD:94:8E", "58:97:BD:CD:94:8F",
  "58:97:BD:CD:9C:04", "58:97:BD:CD:9C:0B", "58:97:BD:CD:9C:0D", "58:97:BD:CD:9C:0E",
  "58:97:BD:CD:9C:14", "58:97:BD:CD:9C:1B", "58:97:BD:CD:9C:60", "58:97:BD:CD:9C:61",
  "58:97:BD:CD:9C:62", "58:97:BD:CD:9C:63", "58:97:BD:CD:9C:6C", "58:97:BD:CD:9C:6D",
  "58:97:BD:CD:9C:6E", "58:97:BD:CD:9C:6F", "58:97:BD:D0:93:D1", "58:97:BD:D0:93:D4",
  "58:97:BD:D0:93:DB", "58:97:BD:D0:93:DD", "58:97:BD:D0:93:DE", "58:97:BD:D0:96:60",
  "58:97:BD:D0:96:61", "58:97:BD:D0:96:62", "58:97:BD:D0:96:63", "58:97:BD:D0:96:6C",
  "58:97:BD:D0:96:6D", "58:97:BD:D0:96:6E", "58:97:BD:D0:96:6F", "58:97:BD:D0:96:B1",
  "58:97:BD:D0:96:B2", "58:97:BD:D0:96:B4", "58:97:BD:D0:96:BB", "58:97:BD:D0:96:BD",
  "58:97:BD:D0:96:BE", "58:97:BD:D0:96:C4", "58:97:BD:D0:97:5B", "58:97:BD:D0:97:5D",
  "58:97:BD:D0:97:5E", "58:97:BD:D7:A5:5D", "58:97:BD:D7:A6:60", "58:97:BD:D7:A6:61",
  "58:97:BD:D7:A6:62", "58:97:BD:D7:A6:63", "58:97:BD:D7:A6:6C", "58:97:BD:D7:A6:6D",
  "58:97:BD:D7:A6:6E", "58:97:BD:D7:A6:6F", "58:D9:D5:41:50:32", "58:D9:D5:41:50:42",
  "58:D9:D5:41:50:72", "58:D9:D5:41:50:92", "58:D9:D5:41:50:A2", "58:FC:20:CA:96:F0",
  "58:FC:20:CA:96:F1", "5C:33:8E:E9:D1:80", "5C:7B:5C:63:BA:06", "5C:83:8F:0C:B4:6D",
  "5C:83:8F:0C:C4:5D", "5C:83:8F:14:C5:4B", "5C:83:8F:14:C5:4C", "5C:83:8F:14:C5:4F",
  "5C:96:9D:6C:06:36", "60:35:C0:14:DA:4D", "60:35:C0:14:DA:4E", "60:35:C0:CE:B2:8D",
  "60:35:C0:CE:B2:8E", "60:38:E0:D6:3F:49", "60:8D:26:91:D2:D5", "68:15:90:30:3E:55",
  "68:A3:78:76:B1:EE", "68:A3:78:76:B1:EF", "68:A3:78:7F:93:A4", "68:A3:78:7F:93:A5",
  "68:A3:78:95:E0:24", "68:A3:78:98:B6:C4", "68:A3:78:A5:F1:38", "68:A3:78:D5:12:18",
  "68:A3:78:D5:12:19", "68:A3:78:D5:E0:60", "68:A3:78:D5:E0:61", "68:AA:C4:04:9D:A0",
  "6C:38:A1:D1:E0:81", "6C:38:A1:FA:0D:E1", "6C:61:F4:32:94:ED", "6C:61:F4:32:94:EE",
  "6C:61:F4:39:A4:45", "6C:61:F4:3A:8F:BD", "6C:61:F4:3A:8F:BE", "6C:61:F4:4B:08:3E",
  "6C:FF:CE:31:9C:44", "70:62:B8:4E:F7:90", "70:62:B8:4E:F7:98", "70:62:B8:4E:F7:F0",
  "70:62:B8:4E:F7:F8", "70:62:B8:4E:F8:30", "70:62:B8:4E:F8:38", "70:62:B8:51:26:20",
  "70:62:B8:51:26:28", "70:DF:2F:9E:25:C0", "70:DF:2F:9E:25:C1", "70:DF:2F:9E:25:C2",
  "70:DF:2F:9E:25:C3", "70:DF:2F:9E:25:CC", "70:DF:2F:9E:25:CD", "70:DF:2F:9E:25:CF",
  "70:DF:2F:EC:54:62", "70:DF:2F:EC:54:64", "70:F0:96:99:85:80", "70:F0:96:99:B4:A0",
  "70:FC:8F:98:E4:4E", "70:FC:8F:98:E4:4F", "70:FC:8F:BD:D6:3C", "70:FC:8F:F3:DD:A4",
  "78:8C:B5:B8:11:FB", "7C:03:D8:7E:9C:27", "80:3F:5D:11:FA:7F", "80:EA:96:EE:36:2C",
  "80:EA:96:EE:36:2D", "84:1E:A3:F6:72:85", "84:B2:61:75:82:01", "84:B2:61:75:82:02",
  "84:B2:61:75:82:04", "84:B2:61:75:82:0C", "84:B2:61:75:82:0D", "84:B2:61:75:82:0E",
  "84:B2:61:75:82:0F", "84:D4:7E:77:11:41", "88:FC:A6:03:AD:4E", "8C:97:EA:1B:92:14",
  "8C:97:EA:1B:92:15", "8C:97:EA:8E:C1:D0", "8C:97:EA:8E:C1:D4", "8C:97:EA:F8:80:88",
  "8C:C5:B4:6E:3B:80", "8C:C5:B4:6E:3B:85", "8C:C5:B4:6E:3B:86", "90:4C:81:7E:0E:A0",
  "90:4C:81:7E:0E:A1", "90:4C:81:7E:0E:A2", "90:4C:81:7E:0E:B0", "90:4C:81:7E:0E:B1",
  "90:72:40:12:A0:D6", "90:84:0D:DD:7E:B3", "94:18:65:E6:91:AE", "94:18:65:E6:91:B0",
  "94:18:65:E7:23:6B", "94:18:65:E7:23:6C", "94:18:65:E7:23:6D", "94:F6:65:5B:39:B8",
  "94:F6:65:5B:39:BC", "94:F6:65:DB:39:B9", "94:F6:65:DB:39:BD", "A0:04:60:B5:B2:B8",
  "A0:8E:78:08:AD:86", "A0:8E:78:08:AD:87", "A0:B5:3C:E9:30:B0", "A4:2B:B0:E9:F1:9C",
  "A4:2B:B0:E9:F1:9D", "A4:3E:51:AB:A0:40", "A4:3E:51:AB:A0:41", "A4:CE:DA:0F:B4:B2",
  "A4:CE:DA:0F:B4:B7", "AC:15:A2:49:FF:C0", "AC:1F:09:0B:A6:AE", "AC:84:C9:26:C0:8F",
  "AC:84:C9:31:54:5E", "AC:84:C9:31:54:5F", "AC:A3:1E:5B:2E:70", "AC:A3:1E:5B:2E:71",
  "AC:A3:1E:5B:2E:73", "AC:CF:7B:A1:F8:85", "B0:6E:BF:66:61:0C", "B0:6E:BF:66:91:BC",
  "B0:7F:B9:62:DD:E0", "B0:7F:B9:64:63:00", "B0:BB:E5:09:2A:50", "B4:E2:65:CA:C7:36",
  "B4:E2:65:CB:6A:D5", "B8:26:6C:56:49:D8", "B8:26:6C:56:49:D9", "B8:26:6C:CC:92:6B",
  "B8:26:6C:FC:EA:8A", "B8:26:6C:FC:EA:8B", "B8:26:6C:FF:62:7D", "B8:27:EB:B6:E5:D4",
  "B8:66:85:87:6E:A0", "B8:A3:86:02:77:3D", "B8:B7:F1:21:D0:D3", "B8:C7:5D:07:E4:DF",
  "B8:C7:5D:07:E4:E0", "C4:41:1E:9C:BD:5F", "C4:6E:1F:34:1B:AA", "C8:54:4B:FE:F8:CF",
  "C8:84:A1:D1:9E:4B", "C8:84:A1:D1:9E:4D", "C8:84:A1:D1:9E:4E", "C8:84:A1:D1:B3:8B",
  "C8:84:A1:D1:B3:8D", "C8:84:A1:D1:B3:8E", "C8:B5:AD:31:FE:F0", "C8:B5:AD:31:FE:F1",
  "C8:B5:AD:31:FE:F2", "C8:BE:19:70:D0:D6", "C8:BE:19:70:D0:D8", "CC:2D:1B:29:78:5D",
  "CC:2D:1B:65:96:0E", "CC:2D:1B:6A:89:B5", "CC:2D:1B:6A:89:B6", "CC:2D:1B:6C:FC:6D",
  "CC:2D:1B:6D:A6:25", "CC:2D:1B:6D:A6:26", "CC:2D:1B:FF:1B:9D", "CC:2D:21:35:B0:F1",
  "CC:2D:21:35:B0:F9", "CC:40:D0:A8:8D:95", "CC:40:D0:A8:8D:96", "CC:F9:57:71:C8:6A",
  "D0:17:C2:D8:1E:98", "D0:17:C2:D8:1E:99", "D0:6E:DE:67:17:F0", "D0:6E:DE:67:17:F4",
  "D0:6E:DE:C9:92:90", "D0:6E:DE:C9:92:94", "D0:FF:98:79:5D:4A", "D4:20:B0:14:1D:11",
  "D4:20:B0:14:1D:12", "D4:20:B0:14:1D:13", "D4:20:B0:14:1D:14", "D4:20:B0:14:1D:21",
  "D4:20:B0:14:1D:22", "D4:20:B0:14:1D:23", "D4:86:60:03:D8:60", "D4:DC:09:BD:71:91",
  "D4:DC:09:BD:71:92", "D4:DC:09:BD:71:93", "D4:DC:09:BD:71:94", "D4:DC:09:BD:71:A1",
  "D4:DC:09:BD:71:A2", "D4:DC:09:BD:71:A3", "D8:07:B6:15:E6:05", "D8:47:32:5C:68:60",
  "D8:47:32:5C:68:61", "D8:47:32:5C:69:1D", "D8:47:32:5C:69:1E", "D8:A7:56:B1:92:EF",
  "D8:C7:C8:24:CA:92", "D8:C7:C8:24:CA:98", "D8:C7:C8:24:CA:99", "D8:C7:C8:24:CA:9A",
  "D8:C7:C8:24:D0:50", "D8:C7:C8:24:D0:51", "D8:C7:C8:24:D0:53", "D8:C7:C8:24:D0:58",
  "D8:C7:C8:24:D0:59", "D8:C7:C8:24:D0:5B", "D8:C7:C8:24:D1:30", "D8:C7:C8:24:D1:31",
  "D8:C7:C8:24:D1:32", "D8:C7:C8:24:D1:38", "D8:C7:C8:24:D1:39", "D8:C7:C8:24:D1:3A",
  "D8:C7:C8:24:D1:80", "D8:C7:C8:24:D1:81", "D8:C7:C8:24:D1:82", "D8:C7:C8:24:D1:88",
  "D8:C7:C8:24:D1:89", "D8:C7:C8:24:D1:8A", "D8:C7:C8:A8:A5:20", "D8:C7:C8:A8:A5:21",
  "D8:C7:C8:A8:A5:28", "D8:C7:C8:A8:A5:29", "D8:C7:C8:A8:A5:2A", "D8:C7:C8:A8:AA:31",
  "D8:C7:C8:A8:AA:38", "D8:C7:C8:A8:AA:39", "D8:C7:C8:A8:AA:3A", "D8:C7:C8:A8:B4:C8",
  "D8:C7:C8:A8:B4:C9", "D8:C7:C8:A8:B4:CA", "D8:C7:C8:A8:B6:68", "D8:C7:C8:A8:B6:69",
  "D8:C7:C8:A8:B6:6A", "D8:C7:C8:A8:B8:70", "D8:C7:C8:A8:B8:71", "D8:C7:C8:A8:B8:72",
  "D8:C7:C8:A8:B8:78", "D8:C7:C8:A8:B8:79", "D8:C7:C8:A8:B8:7A", "D8:C7:C8:A8:B9:00",
  "D8:C7:C8:A8:B9:01", "D8:C7:C8:A8:B9:02", "D8:C7:C8:A8:B9:08", "D8:C7:C8:A8:B9:09",
  "D8:C7:C8:A8:B9:0A", "D8:C7:C8:A8:B9:70", "D8:C7:C8:A8:B9:71", "D8:C7:C8:A8:B9:78",
  "D8:C7:C8:A8:B9:79", "D8:C7:C8:A8:B9:7A", "D8:C7:C8:A8:BC:22", "D8:C7:C8:A8:BC:28",
  "D8:C7:C8:A8:BC:29", "D8:C7:C8:A8:BC:2A", "DC:00:B0:79:71:CD", "DC:00:B0:7B:51:5C",
  "DC:00:B0:7B:51:5E", "DC:00:B0:AC:D6:3C", "DC:00:B0:BC:96:40", "DC:00:B0:BC:96:44",
  "DC:00:B0:F7:5F:80", "DC:00:B0:F7:5F:84", "DC:AE:EB:19:59:28", "DC:AE:EB:19:59:2C",
  "DC:AE:EB:19:5B:48", "DC:AE:EB:19:5B:4C", "DC:AE:EB:59:59:28", "DC:AE:EB:59:59:2C",
  "DC:AE:EB:59:5B:48", "DC:AE:EB:59:5B:4C", "E0:23:FF:C6:9A:B8", "E0:23:FF:C6:9A:C0",
  "E0:23:FF:C6:9A:C1", "E4:9E:12:10:9C:2C", "E4:9E:12:16:8E:CF", "E4:9E:12:16:8E:D0",
  "E4:9E:12:7E:AB:2E", "E4:9E:12:7E:AB:2F", "E4:9E:12:80:6E:64", "E4:9E:12:80:6E:65",
  "E4:9E:12:FD:14:A0", "E4:AA:5D:AC:41:20", "E4:AA:5D:AC:41:22", "E4:AA:5D:AC:41:23",
  "E4:AA:5D:AC:41:2D", "E4:AA:5D:DE:D3:30", "E4:AA:5D:DE:D3:31", "E4:AA:5D:DE:D3:32",
  "E4:AA:5D:DE:D3:33", "E4:AA:5D:DE:D3:3C", "E4:AA:5D:DE:D3:3D", "E4:AA:5D:DE:D3:3E",
  "E4:AA:5D:DE:D3:3F", "E4:AA:5D:DE:DC:C0", "E4:AA:5D:DE:DC:C1", "E4:AA:5D:DE:DC:C2",
  "E4:AA:5D:DE:DC:C3", "E4:AA:5D:DE:DC:CC", "E4:AA:5D:DE:DC:CD", "E4:AA:5D:DE:DC:CE",
  "E4:AA:5D:DE:DC:CF", "E4:AA:5D:E0:EC:31", "E4:AA:5D:E0:EC:32", "E4:AA:5D:E0:EC:34",
  "E4:AA:5D:E0:EC:3B", "E4:AA:5D:E0:EC:3D", "E4:AA:5D:E0:EC:3E", "E4:AA:5D:E2:A0:90",
  "E4:AA:5D:E2:A0:91", "E4:AA:5D:E2:A0:92", "E4:AA:5D:E2:A0:93", "E4:AA:5D:E2:A0:9C",
  "E4:AA:5D:E2:A0:9D", "E4:AA:5D:E2:A0:9E", "E4:AA:5D:E2:A0:9F", "E4:AA:5D:E2:A1:00",
  "E4:AA:5D:E2:A1:01", "E4:AA:5D:E2:A1:02", "E4:AA:5D:E2:A1:03", "E4:AA:5D:E2:A1:0C",
  "E4:AA:5D:E2:A1:0D", "E4:AA:5D:E2:A1:0E", "E4:AA:5D:E2:A1:0F", "E4:AA:5D:E2:A2:00",
  "E4:AA:5D:E2:A2:01", "E4:AA:5D:E2:A2:02", "E4:AA:5D:E2:A2:03", "E4:AA:5D:E2:A2:0C",
  "E4:AA:5D:E2:A2:0D", "E4:AA:5D:E2:A2:0E", "E4:AA:5D:E2:A2:0F", "E4:AA:5D:E7:F3:10",
  "E4:AA:5D:E7:F3:11", "E4:AA:5D:E7:F3:12", "E4:AA:5D:E9:D4:00", "E4:AA:5D:E9:D4:01",
  "E4:AA:5D:E9:D4:02", "E4:AA:5D:E9:D4:03", "E4:AA:5D:E9:D4:0C", "E4:AA:5D:E9:D4:0D",
  "E4:AA:5D:E9:D4:0E", "E4:AA:5D:E9:D4:0F", "E8:10:98:97:09:A1", "E8:10:98:9A:0F:51",
  "E8:10:98:9A:0F:52", "E8:10:98:9A:0F:53", "E8:10:98:9A:0F:54", "E8:10:98:9A:5A:90",
  "E8:10:98:9A:5A:94", "E8:48:B8:81:12:23", "E8:48:B8:81:12:24", "E8:65:D4:13:AF:19",
  "E8:65:D4:13:AF:21", "E8:65:D4:13:AF:24", "E8:65:D4:4E:A6:81", "E8:65:D4:4E:A6:85",
  "E8:65:D4:72:A0:D1", "E8:65:D4:72:A0:D9", "E8:65:D4:72:A0:E1", "E8:65:D4:72:A1:19",
  "E8:65:D4:72:A1:21", "E8:65:D4:72:A1:29", "E8:65:D4:72:AC:59", "E8:65:D4:72:AC:61",
  "E8:65:D4:72:AC:69", "E8:65:D4:72:F9:69", "E8:65:D4:72:F9:6C", "E8:65:D4:72:F9:71",
  "E8:65:D4:72:F9:74", "E8:65:D4:72:F9:79", "E8:65:D4:72:F9:7C", "EC:2C:E2:82:E7:E4",
  "F0:1D:2D:71:C9:AB", "F0:1D:2D:71:C9:AD", "F0:1D:2D:71:C9:AE", "F0:1D:2D:72:06:0D",
  "F0:1D:2D:72:06:0E", "F0:4D:D4:1E:E5:56", "F0:4D:D4:1E:E5:59", "F4:05:95:1A:2C:34",
  "F4:05:95:3E:F2:70", "F4:7F:35:D9:8D:B0", "F4:7F:35:D9:8D:B1", "F4:7F:35:D9:8D:B2",
  "F4:7F:35:D9:8D:B3", "F4:7F:35:D9:8D:B4", "F4:7F:35:D9:CF:60", "F4:7F:35:D9:CF:61",
  "F4:7F:35:D9:CF:62", "F4:7F:35:D9:CF:63", "F4:7F:35:D9:CF:64", "F4:7F:35:D9:CF:6B",
  "F4:7F:35:D9:CF:6C", "F4:7F:35:D9:CF:6D", "F4:7F:35:D9:CF:6E", "F4:7F:35:D9:CF:6F",
  "F4:7F:35:E3:65:70", "F4:7F:35:E3:65:71", "F4:7F:35:E3:65:72", "F4:7F:35:E3:65:73",
  "F4:7F:35:E3:65:74", "F4:7F:35:E3:65:7B", "F4:7F:35:E3:65:7C", "F4:7F:35:E3:65:7D",
  "F4:7F:35:E3:65:7E", "F4:7F:35:E3:65:7F", "F4:CA:E5:BD:C4:04", "F4:CA:E5:BD:C4:05",
  "FC:3F:DB:77:3F:AC", "FC:9C:98:4F:40:16", "FC:F1:36:16:50:47"
};

struct AP {
  uint8_t mac[6];
  int8_t  rssi;
};

// --- LoRa ËæÖÂä©ÂáΩÊï∞ ---
bool readLine(String &out, uint32_t timeoutMs) {
  uint32_t t0 = millis();
  out = "";
  while (millis() - t0 < timeoutMs) {
    while (LoRa.available()) {
      char c = LoRa.read();
      if (c == '\r') continue;
      if (c == '\n') {
        out.trim();
        return out.length() > 0;
      }
      out += c;
    }
    delay(1);
  }
  out.trim();
  return out.length() > 0;
}

int e5SendCmdWait(const String& cmd, uint32_t timeoutMs = 3000, const char* ok1 = "OK", const char* ok2 = nullptr) {
  Serial.println(">> " + cmd);
  LoRa.print(cmd); LoRa.print("\r\n");
  uint32_t t0 = millis();
  while (millis() - t0 < timeoutMs) {
    String line;
    if (readLine(line, 200)) {
      Serial.println("[LoRa-RX] " + line);
      if (line.indexOf("ERROR") >= 0) return -1;
      if (ok1 && line.indexOf(ok1) >= 0) return 1;
      if (ok2 && line.indexOf(ok2) >= 0) return 1;
    }
  }
  return 0;
}

bool e5JoinOTAA(uint32_t timeoutMs = 30000) {
  Serial.println(">> AT+JOIN");
  LoRa.print("AT+JOIN\r\n");
  uint32_t t0 = millis();
  while (millis() - t0 < timeoutMs) {
    String line;
    if (readLine(line, 500)) {
      Serial.println("[LoRa-RX] " + line);
      if (line.indexOf("Network joined") >= 0 || line.indexOf("JOINED") >= 0 || line.indexOf("Done") >= 0) return true;
      if (line.indexOf("failed") >= 0) return false;
    }
  }
  return false;
}

// üî• Ê†∏ÂøÉÈÄªËæëÔºöÊ£ÄÊü•ÊòØÂê¶Âú®ÁôΩÂêçÂçï‰∏≠
bool isWhitelisted(String mac) {
  mac.toUpperCase(); // Áªü‰∏ÄËΩ¨Â§ßÂÜô
  for (int i = 0; i < WHITELIST_SIZE; i++) {
    if (mac.equals(WHITELIST[i])) {
      return true;
    }
  }
  return false;
}

// üî• Êâ´ÊèèÂπ∂ËøáÊª§
int scanAPs(AP* out, int maxn) {
  int n = WiFi.scanNetworks(false, true);
  if (n <= 0) return 0;

  // 1. ÊâæÂá∫ÊâÄÊúâÁôΩÂêçÂçïÂÜÖÁöÑ APÔºåÂ≠òÂÖ•‰∏¥Êó∂ÂàóË°®
  int indices[n]; 
  int validCount = 0;

  Serial.println("--- Scan Result ---");
  for (int i = 0; i < n; i++) {
    String currentMac = WiFi.BSSIDstr(i);
    // Ê£ÄÊü•ÁôΩÂêçÂçï
    if (isWhitelisted(currentMac)) {
      indices[validCount] = i;
      validCount++;
      Serial.println("‚úÖ Found Whitelisted: " + currentMac + " (" + WiFi.SSID(i) + ")");
    } else {
      // ÂèØ‰ª•Âú®ËøôÈáåÊâìÂç∞Ë¢´ÂøΩÁï•ÁöÑÔºåË∞ÉËØïÁî®
      // Serial.println("‚ùå Ignored: " + currentMac); 
    }
  }

  if (validCount == 0) {
    Serial.println("‚ö†Ô∏è No Whitelisted APs found! (Are you in the lab?)");
    WiFi.scanDelete();
    return 0;
  }

  // 2. ÂØπÁôΩÂêçÂçïÂÜÖÁöÑ AP Êåâ‰ø°Âè∑Âº∫Â∫¶ÊéíÂ∫è (ÂÜíÊ≥°)
  for (int i = 0; i < validCount - 1; i++) {
    for (int j = 0; j < validCount - i - 1; j++) {
      if (WiFi.RSSI(indices[j]) < WiFi.RSSI(indices[j + 1])) {
        int temp = indices[j];
        indices[j] = indices[j + 1];
        indices[j + 1] = temp;
      }
    }
  }

  // 3. ÂèñÂâç N ‰∏™ (ÂÆûÈ™åË¶ÅÊ±ÇTop 3)
  int m = 0;
  for (int i = 0; i < validCount && m < maxn; i++) {
    int idx = indices[i];
    WiFi.BSSID(idx, out[m].mac);
    out[m].rssi = (int8_t)WiFi.RSSI(idx);
    m++;
  }

  WiFi.scanDelete();
  return m;
}

String toHex(const uint8_t* buf, int len) {
  const char* hexChars = "0123456789ABCDEF";
  String s; s.reserve(len * 2);
  for (int i = 0; i < len; i++) {
    s += hexChars[(buf[i] >> 4) & 0xF];
    s += hexChars[buf[i] & 0xF];
  }
  return s;
}

void setup() {
  Serial.begin(115200);
  delay(200);
  // ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Á°ÆËÆ§‰Ω†ÁöÑÂºïËÑöÔºöÂ∏∏ËßÑÊùøÂ≠êÁî® 16, 17ÔºõWROVER Áî® 4, 5
  LoRa.begin(9600, SERIAL_8N1, 16, 17);
  // LoRa.begin(9600, SERIAL_8N1, 4, 5); 
  
  WiFi.mode(WIFI_STA);
  WiFi.disconnect();
  delay(1000);

  Serial.println("=== System Start (Whitelist Mode) ===");
  
  if (e5SendCmdWait("AT", 2000) <= 0) {
    Serial.println("!! LoRa Module No Response !! Check Wiring.");
    while(1); 
  }
  
  e5SendCmdWait("AT+MODE=LWOTAA", 3000);
  e5SendCmdWait(String("AT+ID=DevEui,") + DEV_EUI, 3000);
  e5SendCmdWait(String("AT+ID=AppEui,") + APP_EUI, 3000);
  e5SendCmdWait(String("AT+KEY=APPKEY,") + APP_KEY, 3000);
  e5SendCmdWait("AT+CLASS=A", 3000);
  e5SendCmdWait(String("AT+PORT=") + LORAWAN_PORT, 3000);
  e5SendCmdWait(String("AT+DR=") + JOIN_DR, 3000);

  bool joined = false;
  for (int i = 0; i < 3 && !joined; i++) joined = e5JoinOTAA(20000);

  if (joined) {
    Serial.println("== JOIN success ==");
    e5SendCmdWait(String("AT+DR=") + UPLINK_DR, 3000);
  } else {
    Serial.println("!! JOIN failed !!");
  }
}

void loop() {
  AP aps[N];
  int count = scanAPs(aps, N); 

  if (count > 0) {
    uint8_t payload[64];
    int ptr = 0;
    payload[ptr++] = (uint8_t)count;

    for (int i = 0; i < count; i++) {
      memcpy(&payload[ptr], aps[i].mac, 6);
      ptr += 6;
      payload[ptr++] = (uint8_t)aps[i].rssi;
    }

    uint16_t ts = (millis() / 1000) & 0xFFFF;
    payload[ptr++] = (ts >> 8) & 0xFF;
    payload[ptr++] = ts & 0xFF;

    String hexPayload = toHex(payload, ptr);
    Serial.printf("Sending Whitelisted APs: %s\n", hexPayload.c_str());
    e5SendCmdWait(String("AT+MSGHEX=") + hexPayload, 12000, "Done", "OK");
  } else {
    Serial.println("No Whitelisted APs found. Skipping upload.");
  }

  delay(PERIOD_MS);
}